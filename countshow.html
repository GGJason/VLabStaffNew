<!DOCTYPE HTML>
<!--
	Phantom by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>人數統計 | V.Lab Staff</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="css/main.css" />
		<!--[if lte IE 9]><link rel="stylesheet" href="css/ie9.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="css/ie8.css" /><![endif]-->
		<meta lang="zh-Hant">
		<meta name="description" content="臺大土木系V.Lab工讀生的工作專區">
		<!--jQurey-->
		<script src="js/jquery.min.js"></script>

		<link href="./css/font-awesome.min.css" type="text/css" rel="stylesheet"/>
		<style>
			.action{
				text-align:center;
			}
			.action div{
				margin:0 auto;
				width:33%;
				padding: 50pt 0 50pt 0;
				background: steelblue;
				color:white;
				font-size:24pt;
				text-align:center;
				display:inline-block;
				border:none;
			}
			.action div:active{
				background:blue;
			}
			.action div i{
				margin: 40pt;
			}
			#date{
				width:100%;
				text-align:center;
				font-size:28pt;
				border:none;
				padding: 10pt 0 10pt 50pt;
			}
			#count{
				border: solid black;
				width:100%;
				margin-bottom:20pt;
				text-align:center;
				padding:30pt;
				font-size:32pt;
			}
			.date{
			}
			
svg {
  font: 10px sans-serif;
}

.y.axis path {
  display: none;
}

.y.axis line {
  stroke: #fff;
  stroke-opacity: .2;
  shape-rendering: crispEdges;
}

.y.axis .zero line {
  stroke: #000;
  stroke-opacity: 1;
}

.birthyear,
.age {
  text-anchor: middle;
}

.birthyear {
  fill: #fff;
}

rect {
  fill-opacity: .6;
  fill: #e377c2;
}

rect:first-child {
  fill: #1f77b4;
}
		.bar2017{
		 	fill:#B2FFC3
		}
		.bar2016{
		 	fill:#00FF3A
		}
		.bar2015{
		 	fill:#00CA2E
		}
		.bar2014{
		 	fill:#1A8933
		}
		.bar2013{
		 	fill:#004C11
		}
		</style>
		<script src="./js/jquery.min.js"></script>
		<script src="./js/d3.min.js"></script>
		<script src="./js/main.js"></script>
		
	</head>
	<body>
	<!-- Wrapper -->
			<div id="wrapper">
				<!-- Header -->
					<header id="header">
					<script src="js/header.js"></script>
					</header>

				<!-- Menu -->
					<nav id="menu">
					<script type="text/javascript" src="js/menuChangeable.js"></script>
					</nav>
				<!-- Main -->
					<div id="main">
						<div class="inner">
							<header>
							<h1>人數統計</h1>
							</header>
							<section>
								<button onclick="stacked();">Stacked</button>
								<button onclick="list();">List</button>
								<div id="show" >
									<!--<table>
										<div>
											<div class="bar2013" style="display:inline-block">2013</div>
											<div class="bar2014" style="display:inline-block">2014</td>
											<div class="bar2015" style="display:inline-block">2015</td>
											<div class="bar2016" style="display:inline-block">2016</td>
											<div class="bar2017" style="display:inline-block">2017</td>
										</div>
									</table>-->
									<div id="showOption" ></div>
									<div id="showContent"><svg width="1080" height="500"></svg></div>
								</div>
								<div id="table" class="count">
								</div>
							</section>
						</div>
					</div>

				<!-- Footer -->
					<footer id="footer">
						<div class="inner">
							<section>
								<h2>Get in touch</h2>
								<form method="post" action="#">
									<div class="field half first">
										<input type="text" name="name" id="name" placeholder="Name" />
									</div>
									<div class="field half">
										<input type="email" name="email" id="email" placeholder="Email" />
									</div>
									<div class="field">
										<textarea name="message" id="message" placeholder="Message"></textarea>
									</div>
									<ul class="actions">
										<li><input type="submit" value="Send" class="special" /></li>
									</ul>
								</form>
							</section>
							<section>
								<h2>Follow</h2>
								<ul class="icons">
									<li><a href="#" class="icon style2 fa-twitter"><span class="label">Twitter</span></a></li>
									<li><a href="#" class="icon style2 fa-facebook"><span class="label">Facebook</span></a></li>
									<li><a href="#" class="icon style2 fa-instagram"><span class="label">Instagram</span></a></li>
									<li><a href="#" class="icon style2 fa-dribbble"><span class="label">Dribbble</span></a></li>
									<li><a href="#" class="icon style2 fa-github"><span class="label">GitHub</span></a></li>
									<li><a href="#" class="icon style2 fa-500px"><span class="label">500px</span></a></li>
									<li><a href="#" class="icon style2 fa-phone"><span class="label">Phone</span></a></li>
									<li><a href="#" class="icon style2 fa-envelope-o"><span class="label">Email</span></a></li>
								</ul>
							</section>
							<ul class="copyright">
								<li>&copy; Untitled. All rights reserved</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
							</ul>
						</div>
					</footer>

			</div>
	</body>
	<script>
				var svg = d3.select("svg"),
					margin = {top: 20, right: 20, bottom: 30, left: 50},
					width = +svg.attr("width") - margin.left - margin.right,
					height = +svg.attr("height") - margin.top - margin.bottom,
					g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
					
				var x = d3.scaleLinear()
					.rangeRound([80, width-20],.1);
				var y = d3.scaleLinear()
				    .rangeRound([height, 0]);
				var center;
				d3.json("./count.php?show&month",function(error, data) {
  					var dateFmt = d3.timeFormat('%Y-%m-%d');
  					minDate = new Date();
  					data.months = [0,0,0,0,0,0,0,0,0,0,0,0,0];
					data.forEach(function(d) {
    					d.date = new Date(d.date);
    					d.year = d.date.getFullYear();
    					d.month = d.date.getMonth()+1;
    					if(d.date<minDate)
    						minDate = d.date;
    					d.count = +d.count;
    					d.bottom = data.months[d.month];
    					data.months[d.month]+=d.count;
    					d.top = data.months[d.month];
					});
					if (error) throw error;
					barwidth = width / 15 / (Math.floor((new Date()-minDate )/365/24/60/60/1000)+1);
					//console.log(barwidth);
					center = Math.floor((new Date()-minDate )/365/24/60/60/1000/2+minDate.getFullYear()-1);
					//x.domain([d3.min(data, function(d) { return d.date; }),d3.max(data, function(d) { return d.date; })]);
					dataSave = data;
					list();
					/*x.domain([1,12])
					y.domain([0,d3.max(data, function(d) { return d.count; })]);

					g.append("g")
  						.attr("transform", "translate(0," + height + ")")
  						.call(d3.axisBottom(x))
						.select(".domain")
  						.remove();

					g.append("g")
  						.call(d3.axisLeft(y))
						.append("text")
					  	.attr("fill", "#000")
					  	.attr("transform", "rotate(-90)")
					  	.attr("y", 6)
					  	.attr("dy", "0.71em")
					  	.attr("text-anchor", "end")
					  	.text("People");

				  	/*g.append("path")
					  	.datum(data)
					  	.attr("fill", "none")
					  	.attr("stroke", "steelblue")
					  	.attr("stroke-linejoin", "round")
					  	.attr("stroke-linecap", "round")
					  	.attr("stroke-width", 1.5)
					  	.attr("d", line);
					 g.selectAll("rect")
					 	.data(data)
					 	.enter()
					 	.append("rect")
					 	.attr("x",function(d){	 		
					 		var years = Math.floor((d.date-new Date().setFullYear(center))/365/24/60/60/1000); 
					 		return x(d.month)-barwidth/2+years*barwidth;})
					 	.attr("width",barwidth)
					 	.attr("y",function(d){return y(d["count"]);})
					 	.attr("height",function(d){return height - y(d["count"]);})
					 	.attr("class",function(d){return "bar"+d.year;})
				 	
					g.selectAll("text .data")
					 	.data(data)
					 	.enter()
					   .append("text")
					   
					  	.text(function(d){return d["count"];})
					 	.attr("x",function(d){	 		
					 		var years = Math.floor((d.date-new Date().setFullYear(center))/365/24/60/60/1000); 
					 		return x(d.month)-barwidth/2+years*barwidth;})
					 	.attr("y",function(d){return  y(d["count"])-3})*/
					//console.log(data.months);
				});
			function mouseover(){
				
			}
			function list(){
				g.selectAll("g").remove()
				g.selectAll("text").remove()
				barwidth = width / 15 / (Math.floor((new Date()-minDate )/365/24/60/60/1000)+1);
					//console.log(barwidth);
					//x.domain([d3.min(data, function(d) { return d.date; }),d3.max(data, function(d) { return d.date; })]);
					data = dataSave;
					g.selectAll("g").remove();
					g.selectAll("rect").remove();
					x.domain([1,12])
					y.domain([0,d3.max(data, function(d) { return d.count; })]);

					g.append("g")
  						.attr("transform", "translate(0," + height + ")")
  						.call(d3.axisBottom(x))
						.select(".domain")
  						.remove();

					g.append("g")
  						.call(d3.axisLeft(y))
						.append("text")
					  	.attr("fill", "#000")
					  	.attr("transform", "rotate(-90)")
					  	.attr("y", 6)
					  	.attr("dy", "0.71em")
					  	.attr("text-anchor", "end")
					  	.text("People");

				  	/*g.append("path")
					  	.datum(data)
					  	.attr("fill", "none")
					  	.attr("stroke", "steelblue")
					  	.attr("stroke-linejoin", "round")
					  	.attr("stroke-linecap", "round")
					  	.attr("stroke-width", 1.5)
					  	.attr("d", line);*/
					 g.selectAll("rect")
					 	.data(data)
					 	.enter()
					 	.append("rect")
					 	.attr("x",function(d){
					 		change = d.date; 
					 		
					 		var years = Math.floor((change-new Date().setFullYear(center))/365/24/60/60/1000); 
					 		
					 		//change.setFullYear(center);
					 		console.log(years +" " +d.year+" "+center); 
					 		
					 		return x(d.month)-barwidth/2+years*barwidth;})
					 	.attr("width",barwidth)
					 	.attr("y",function(d){return y(d["count"]);})
					 	.attr("height",function(d){return height - y(d["count"]);})
					 	.attr("class",function(d){return "bar"+d.year;})
					g.selectAll("text .data")
					 	.data(data)
					 	.enter()
					 	
					   .append("text")
					  	.text(function(d){return d["count"];})
					 	.attr("text-anchor","middle")
					 	.attr("transform",function(d){	
					 		var years = Math.floor((d.date-new Date().setFullYear(center))/365/24/60/60/1000);
					 		console.log("translate("+(x(d.month)-barwidth/4+years*barwidth)+","+(y(d["count"])-3)+") rotate(-45)");
					 		return "translate("+(x(d.month)+years*barwidth)+","+(y(d["count"])-3)+") rotate(-45)"
					 	}) 
					 	/*.attr("x",function(d){	 		
					 		var years = Math.floor((d.date-new Date().setFullYear(center))/365/24/60/60/1000); 
					 		return x(d.month)-barwidth/4+years*barwidth;})
					 	.attr("y",function(d){return  y(d["count"])-3})
					 	*/
			}
			function stacked (){
				barwidth=width/14;
				tempMonths = dataSave.months;
				//console.log(dataSave);
				y.domain([0,d3.max(dataSave.months,function(d){return d;})]);
				g.selectAll("g").remove()
				g.selectAll("text").remove()
				g.append("g")
  						.call(d3.axisLeft(y))
						.append("text")
					  	.attr("fill", "#000")
					  	.attr("transform", "rotate(-90)")
					  	.attr("y", 6)
					  	.attr("dy", "0.71em")
					  	.attr("text-anchor", "end")
					  	.text("People");
					  	g.append("g")
  						.attr("transform", "translate(0," + height + ")")
  						.call(d3.axisBottom(x))
						.select(".domain")
  						.remove();
				g.selectAll("rect")
				.remove();
				g.selectAll("rect")
				  	.data(dataSave)
				  	.enter()
				  .append("rect")
				  	.attr("x",function(d){
				 		change = d.date; 
				 		
				 		var years = Math.floor((change-new Date().setFullYear(center))/365/24/60/60/1000); 
				 		
				 		return x(d.month)-barwidth/2;})
				 	.attr("width",barwidth)
				 	.attr("y",function(d){ return y(d.top);})
				 	.attr("height",function(d){return y(d.bottom)-y(d.top);})
				 	.attr("class",function(d){return "bar"+d.year;});
				 	
				 	g.selectAll("text .data")
					 	.data(dataSave)
					 	.enter()
					   .append("text")
					  	.text(function(d){return d["count"];})
					  	.attr("text-anchor","middle")
					 	.attr("x",function(d){	 		
					 		var years = Math.floor((d.date-new Date().setFullYear(center))/365/24/60/60/1000); 
					 		return x(d.month);})
					 	.attr("y",function(d){return  (y(d.top)+y(d.bottom))/2 + 3 ;})
}
		</script>
</html>
